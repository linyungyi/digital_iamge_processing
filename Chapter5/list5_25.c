#include "image.h"
#include <stdlib.h>

main(int ac,char *av[])
{
	ImageData *img,*outimg;
	int res;
	int x,y,mx,my;

	if(ac<3) {
		printf("パラメータが足りません");
		return;
	}

	// ファイルより画像データの読み込み
	res=readBMPfile(av[1],&img);
	if(res<0) {
		printf("画像が読めません");
		return;
	}

	// 結果格納用画像データ作成
	outimg=createImage(img->width,img->height,24);
	
	effect(img,outimg);

	writeBMPfile(av[2],outimg);
	disposeImage(img);
	disposeImage(outimg);

}

static short dith_col[256][64];
static short dith_colb[256][64];

// ディザでのカラーマップを作成する
int setcoltab8()
{
	int i,x,y;
	int col;
int d_up[256]={
	 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
	 0, 0, 0, 0, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
	 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1,
	 1, 1, 1, 1, 1, 1, 1, 1, 1, 2, 2, 2, 2, 2, 2, 2,
	 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2,
	 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3,
	 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
	 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3,
	 3, 3, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
	 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4, 4,
	 4, 4, 4, 4, 4, 4, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
	 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5,
	 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 6, 6, 6, 6, 6,
	 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6,
	 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 6, 7};

int d_low[256]= {
	 0, 2, 4, 6, 8,10,12,14,15,17,19,21,22,24,26,28,
	29,31,33,35,36,38,40,42,43,45,47,49,50,52,54,56,
	57,59,61,63, 0, 2, 4, 5, 7, 9,11,12,14,16,18,19,
	21,23,25,26,28,30,32,33,35,37,39,40,42,44,46,47,
	49,51,53,54,56,58,60,61,63, 1, 3, 4, 6, 8,10,11,
	13,15,17,18,20,22,24,25,27,29,31,32,34,36,38,39,
	41,43,45,46,48,50,52,53,55,57,59,60,62, 0, 2, 3,
	 5, 7, 9,10,12,14,16,17,19,21,23,24,26,28,30,31,
	33,35,37,38,40,42,44,45,47,49,51,52,54,56,58,59,
	61,63, 1, 2, 4, 6, 8, 9,11,13,15,16,18,20,22,23,
	25,27,29,30,32,34,36,37,39,41,43,44,46,48,50,51,
	53,55,57,58,60,62, 0, 1, 3, 5, 7, 8,10,12,14,15,
	17,19,21,22,24,26,28,29,31,33,35,36,38,40,42,43,
	45,47,49,50,52,54,56,57,59,61,63, 0, 2, 4, 6, 7,
	 9,11,13,14,16,18,20,21,23,25,27,28,30,32,34,35,
	37,39,41,42,44,46,48,49,51,53,55,56,58,60,62, 0};
static int dith_pat4[16]=
			{  0, 8, 2,10,
			  12, 4,14,	6,
			   3,11, 1,	9,
			  15, 7,13,	5 };

static int dith_pat8[64]={
	 0,32, 8,40, 2,34,10,42,
	48,16,56,24,50,18,58,26,
	12,44, 4,36,14,46, 6,38,
	60,28,52,20,62,30,54,22,
	 3,35,11,43, 1,33, 9,41,
	51,19,59,27,49,17,57,25,
	15,47, 7,39,13,45, 5,37,
	63,31,55,23,61,29,53,21};

	for(i=0;i<256;i++) {
		for(y=0;y<8;y++) {
			for(x=0;x<8;x++) {
				col=d_up[i];
				if(d_low[i]>dith_pat8[(x+(y<<3))]) col++;
				dith_col[i][y*8+x]=col*32;
				col=d_up[i*109/255];
				if(d_low[i*109/255]>dith_pat8[(x+(y<<3))]) col++;
				dith_colb[i][y*8+x]=col*64;
			}
		}
	}
	return TRUE;
}

// エフェクト処理
int effect(ImageData *img,ImageData *outimg)
{
	int x,y;
	int val;
	int rr,gg,bb;
	int adr;
	Pixel col;

	setcoltab8();
	for(y=0;y<img->height;y++) {
		for(x=0;x<img->width;x++) {
			val = getPixel(img,x,y,&col);	//画像上の画素情報を取得
			rr=col.r;
			gg=col.g;
			bb=col.b;
			adr=(x&7)+((y&7)<<3);
			rr=dith_col[rr][adr];
			gg=dith_col[gg][adr];
			bb=dith_colb[bb][adr];
			col.r = rr;
			col.g = gg;
			col.b = bb;
			setPixel(outimg,x,y,&col);	// 画像に値をセットする
		}
	}
	return TRUE;
}
